use Test::More tests => 43;
use Cwd;
use URI::Escape;
use MolochTest;
use JSON;
use Test::Differences;
use Data::Dumper;
use strict;

my $pwd = getcwd() . "/pcap";

my $json;

#node
    $json = viewerGet("/spigraph.json?date=-1&field=no&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "map field: no");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "lpHisto field: no");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "paHisto field: no");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "dbHisto field: no");
    eq_or_diff($json->{items}, from_json('[{ "name": "test", "count": 5, "graph": { "lpHisto": [ [ 1335956400000, 1 ], [ 1386003600000, 3 ], [ 1387742400000, 1 ] ], "dbHisto": [ [ 1335956400000, 0 ], [ 1386003600000, 5287 ], [ 1387742400000, 68 ] ], "paHisto": [ [ 1335956400000, 2 ], [ 1386003600000, 46 ], [ 1387742400000, 4 ] ], "xmin": 1335956400000, "xmax": 1387742400000, "interval": 3600 }, "map": {"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}, "dbHisto": 5355, "lpHisto": 5, "paHisto": 52 } ]'), "items field: no");

#node multi
    $json = multiGet("/spigraph.json?date=-1&field=no&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "multi map field: no");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "multi lpHisto field: no");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "multi paHisto field: no");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "multi dbHisto field: no");
    eq_or_diff($json->{items}, from_json('[{ "name": "test", "count": 5, "graph": { "lpHisto": [ [ 1335956400000, 1 ], [ 1386003600000, 3 ], [ 1387742400000, 1 ] ], "dbHisto": [ [ 1335956400000, 0 ], [ 1386003600000, 5287 ], [ 1387742400000, 68 ] ], "paHisto": [ [ 1335956400000, 2 ], [ 1386003600000, 46 ], [ 1387742400000, 4 ] ], "xmin": 1335956400000, "xmax": 1387742400000, "interval": 3600 }, "map": {"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}, "dbHisto": 5355, "lpHisto": 5, "paHisto": 52 } ]'), "multi items field: no");
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "multi map ALL");



#ta
    $json = viewerGet("/spigraph.json?date=-1&field=ta&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "map field: ta");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "lpHisto field: ta");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "paHisto field: ta");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "dbHisto field: ta");

    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"paHisto":46,"count":3,"dbHisto":5287,"lpHisto":3,"graph":{"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"paHisto":[[1386003600000,46]],"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"map":{"src":{"USA":3},"dst":{"USA":3}},"name":"byhost2"},{"name":"byip2","lpHisto":1,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]]},"map":{"src":{},"dst":{}},"paHisto":2,"dbHisto":0,"count":1},{"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]]},"map":{"dst":{"USA":3},"src":{"USA":3}},"name":"domainwise"},{"name":"dstip","paHisto":4,"dbHisto":68,"count":1,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1387742400000,1]],"xmax":1387742400000,"dbHisto":[[1387742400000,68]],"paHisto":[[1387742400000,4]]},"lpHisto":1,"map":{"dst":{"CAN":1},"src":{"RUS":1}}},{"name":"hosttaggertest1","lpHisto":3,"graph":{"lpHisto":[[1386003600000,3]],"paHisto":[[1386003600000,46]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"count":3,"dbHisto":5287},{"name":"hosttaggertest2","graph":{"paHisto":[[1386003600000,46]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"lpHisto":3,"map":{"dst":{"USA":3},"src":{"USA":3}},"dbHisto":5287,"count":3,"paHisto":46},{"count":1,"dbHisto":0,"paHisto":2,"map":{"dst":{},"src":{}},"lpHisto":1,"graph":{"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]],"xmin":1335956400000,"interval":3600},"name":"iptaggertest1"},{"name":"iptaggertest2","paHisto":2,"count":1,"dbHisto":0,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]]},"lpHisto":1,"map":{"src":{},"dst":{}}},{"dbHisto":0,"count":1,"paHisto":2,"graph":{"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"dbHisto":[[1335956400000,0]],"xmax":1387742400000,"xmin":1335956400000,"interval":3600},"lpHisto":1,"map":{"dst":{},"src":{}},"name":"ipwise"},{"name":"ipwisecsv","map":{"src":{"RUS":1},"dst":{"CAN":1}},"lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"xmax":1387742400000,"dbHisto":[[1387742400000,68]],"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"paHisto":4,"dbHisto":68,"count":1},{"name":"srcip","paHisto":4,"count":1,"dbHisto":68,"lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"dbHisto":[[1387742400000,68]],"xmax":1387742400000,"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"CAN":1},"src":{"RUS":1}}},{"map":{"dst":{"USA":3},"src":{"USA":3}},"lpHisto":3,"graph":{"paHisto":[[1386003600000,46]],"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"count":3,"dbHisto":5287,"paHisto":46,"name":"wisebyhost2"},{"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]],"paHisto":[[1335956400000,2]]},"lpHisto":1,"map":{"dst":{},"src":{}},"dbHisto":0,"count":1,"paHisto":2,"name":"wisebyip2"}]'), "items field: ta");

#ta multi
    $json = multiGet("/spigraph.json?date=-1&field=ta&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "multi map field: ta");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "multi lpHisto field: ta");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "multi paHisto field: ta");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "multi dbHisto field: ta");

    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"paHisto":46,"count":3,"dbHisto":5287,"lpHisto":3,"graph":{"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"paHisto":[[1386003600000,46]],"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"map":{"src":{"USA":3},"dst":{"USA":3}},"name":"byhost2"},{"name":"byip2","lpHisto":1,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]]},"map":{"src":{},"dst":{}},"paHisto":2,"dbHisto":0,"count":1},{"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]]},"map":{"dst":{"USA":3},"src":{"USA":3}},"name":"domainwise"},{"name":"dstip","paHisto":4,"dbHisto":68,"count":1,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1387742400000,1]],"xmax":1387742400000,"dbHisto":[[1387742400000,68]],"paHisto":[[1387742400000,4]]},"lpHisto":1,"map":{"dst":{"CAN":1},"src":{"RUS":1}}},{"name":"hosttaggertest1","lpHisto":3,"graph":{"lpHisto":[[1386003600000,3]],"paHisto":[[1386003600000,46]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"count":3,"dbHisto":5287},{"name":"hosttaggertest2","graph":{"paHisto":[[1386003600000,46]],"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"lpHisto":3,"map":{"dst":{"USA":3},"src":{"USA":3}},"dbHisto":5287,"count":3,"paHisto":46},{"count":1,"dbHisto":0,"paHisto":2,"map":{"dst":{},"src":{}},"lpHisto":1,"graph":{"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]],"xmin":1335956400000,"interval":3600},"name":"iptaggertest1"},{"name":"iptaggertest2","paHisto":2,"count":1,"dbHisto":0,"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]]},"lpHisto":1,"map":{"src":{},"dst":{}}},{"dbHisto":0,"count":1,"paHisto":2,"graph":{"lpHisto":[[1335956400000,1]],"paHisto":[[1335956400000,2]],"dbHisto":[[1335956400000,0]],"xmax":1387742400000,"xmin":1335956400000,"interval":3600},"lpHisto":1,"map":{"dst":{},"src":{}},"name":"ipwise"},{"name":"ipwisecsv","map":{"src":{"RUS":1},"dst":{"CAN":1}},"lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"xmax":1387742400000,"dbHisto":[[1387742400000,68]],"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"paHisto":4,"dbHisto":68,"count":1},{"name":"srcip","paHisto":4,"count":1,"dbHisto":68,"lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"dbHisto":[[1387742400000,68]],"xmax":1387742400000,"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"CAN":1},"src":{"RUS":1}}},{"map":{"dst":{"USA":3},"src":{"USA":3}},"lpHisto":3,"graph":{"paHisto":[[1386003600000,46]],"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"lpHisto":[[1386003600000,3]],"interval":3600,"xmin":1335956400000},"count":3,"dbHisto":5287,"paHisto":46,"name":"wisebyhost2"},{"graph":{"xmin":1335956400000,"interval":3600,"lpHisto":[[1335956400000,1]],"xmax":1387742400000,"dbHisto":[[1335956400000,0]],"paHisto":[[1335956400000,2]]},"lpHisto":1,"map":{"dst":{},"src":{}},"dbHisto":0,"count":1,"paHisto":2,"name":"wisebyip2"}]'), "multi items field: ta");


#a1
    $json = viewerGet("/spigraph.json?date=-1&field=a1&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "map field: a1");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "lpHisto field: a1");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "paHisto field: a1");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "dbHisto field: a1");
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"name":"10.0.0.1","lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"dbHisto":[[1387742400000,68]],"xmax":1387742400000,"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"CAN":1},"src":{"RUS":1}},"dbHisto":68,"count":1,"paHisto":4},{"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3,"map":{"dst":{"USA":3},"src":{"USA":3}},"graph":{"interval":3600,"xmin":1335956400000,"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]],"lpHisto":[[1386003600000,3]]},"name":"10.180.156.185"},{"name":"192.168.177.160","lpHisto":1,"map":{"dst":{},"src":{}},"graph":{"interval":3600,"xmin":1335956400000,"dbHisto":[[1335956400000,0]],"xmax":1387742400000,"paHisto":[[1335956400000,2]],"lpHisto":[[1335956400000,1]]},"count":1,"dbHisto":0,"paHisto":2}]'), "items field: a1");

#a1 multi
    $json = multiGet("/spigraph.json?date=-1&field=a1&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "multi map field: a1");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "multi lpHisto field: a1");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "multi paHisto field: a1");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "multi dbHisto field: a1");
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"name":"10.0.0.1","lpHisto":1,"graph":{"lpHisto":[[1387742400000,1]],"dbHisto":[[1387742400000,68]],"xmax":1387742400000,"paHisto":[[1387742400000,4]],"xmin":1335956400000,"interval":3600},"map":{"dst":{"CAN":1},"src":{"RUS":1}},"dbHisto":68,"count":1,"paHisto":4},{"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3,"map":{"dst":{"USA":3},"src":{"USA":3}},"graph":{"interval":3600,"xmin":1335956400000,"xmax":1387742400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]],"lpHisto":[[1386003600000,3]]},"name":"10.180.156.185"},{"name":"192.168.177.160","lpHisto":1,"map":{"dst":{},"src":{}},"graph":{"interval":3600,"xmin":1335956400000,"dbHisto":[[1335956400000,0]],"xmax":1387742400000,"paHisto":[[1335956400000,2]],"lpHisto":[[1335956400000,1]]},"count":1,"dbHisto":0,"paHisto":2}]'), "multi items field: a1");

#hh1
    $json = viewerGet("/spigraph.json?date=-1&field=hh1&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "map field: hh1");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "lpHisto field: hh1");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "paHisto field: hh1");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "dbHisto field: hh1");
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"dbHisto":5287,"count":3,"lpHisto":3,"name":"accept","map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"graph":{"paHisto":[[1386003600000,46]],"xmin":1335956400000,"dbHisto":[[1386003600000,5287]],"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"interval":3600}},{"count":3,"dbHisto":5287,"lpHisto":3,"name":"host","map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"graph":{"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"interval":3600,"xmin":1335956400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]]}},{"name":"user-agent","map":{"src":{"USA":3},"dst":{"USA":3}},"graph":{"paHisto":[[1386003600000,46]],"xmax":1387742400000,"interval":3600,"lpHisto":[[1386003600000,3]],"dbHisto":[[1386003600000,5287]],"xmin":1335956400000},"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3}]'), "items field: hh1");

#hh1 multi
    $json = multiGet("/spigraph.json?date=-1&field=hh1&expression=" . uri_escape("file=$pwd/bigendian.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    eq_or_diff($json->{map}, from_json('{"dst":{"USA": 3, "CAN": 1}, "src":{"USA": 3, "RUS":1}}'), "multi map field: hh1");
    eq_or_diff($json->{graph}->{lpHisto}, from_json('[["1335956400000", 1], ["1386003600000", 3], [1387742400000, 1]]'), "multi lpHisto field: hh1");
    eq_or_diff($json->{graph}->{paHisto}, from_json('[["1335956400000", 2], ["1386003600000", 46], [1387742400000, 4]]'), "multi paHisto field: hh1");
    eq_or_diff($json->{graph}->{dbHisto}, from_json('[["1335956400000", 0], ["1386003600000", 5287], [1387742400000, 68]]'), "multi dbHisto field: hh1");
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"dbHisto":5287,"count":3,"lpHisto":3,"name":"accept","map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"graph":{"paHisto":[[1386003600000,46]],"xmin":1335956400000,"dbHisto":[[1386003600000,5287]],"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"interval":3600}},{"count":3,"dbHisto":5287,"lpHisto":3,"name":"host","map":{"dst":{"USA":3},"src":{"USA":3}},"paHisto":46,"graph":{"lpHisto":[[1386003600000,3]],"xmax":1387742400000,"interval":3600,"xmin":1335956400000,"dbHisto":[[1386003600000,5287]],"paHisto":[[1386003600000,46]]}},{"name":"user-agent","map":{"src":{"USA":3},"dst":{"USA":3}},"graph":{"paHisto":[[1386003600000,46]],"xmax":1387742400000,"interval":3600,"lpHisto":[[1386003600000,3]],"dbHisto":[[1386003600000,5287]],"xmin":1335956400000},"paHisto":46,"dbHisto":5287,"count":3,"lpHisto":3}]'), "multi items field: hh1");

#rawua
    $json = viewerGet("/spigraph.json?date=-1&field=rawua&expression=" . uri_escape("file=$pwd/socks5-reverse.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"paHisto":52,"graph":{"xmin":1386003600000,"paHisto":[[1386788400000,52]],"interval":3600,"xmax":1387742400000,"lpHisto":[[1386788400000,1]],"dbHisto":[[1386788400000,24346]]},"count":1,"name":"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)","map":{"dst":{"CAN":1},"src":{"RUS":1}},"dbHisto":24346,"lpHisto":1},{"lpHisto":3,"dbHisto":5287,"map":{"dst":{"USA":3},"src":{"USA":3}},"name":"curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8y zlib/1.2.5","count":3,"graph":{"lpHisto":[[1386003600000,3]],"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"xmin":1386003600000,"paHisto":[[1386003600000,46]],"interval":3600},"paHisto":46}]'), "items field: rawua");

#rawua multi
    $json = multiGet("/spigraph.json?date=-1&field=rawua&expression=" . uri_escape("file=$pwd/socks5-reverse.pcap|file=$pwd/socks-http-example.pcap|file=$pwd/bt-tcp.pcap"));
    my @items = sort({$a->{name} cmp $b->{name}} @{$json->{items}});
    eq_or_diff(\@items, from_json('[{"paHisto":52,"graph":{"xmin":1386003600000,"paHisto":[[1386788400000,52]],"interval":3600,"xmax":1387742400000,"lpHisto":[[1386788400000,1]],"dbHisto":[[1386788400000,24346]]},"count":1,"name":"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)","map":{"dst":{"CAN":1},"src":{"RUS":1}},"dbHisto":24346,"lpHisto":1},{"lpHisto":3,"dbHisto":5287,"map":{"dst":{"USA":3},"src":{"USA":3}},"name":"curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8y zlib/1.2.5","count":3,"graph":{"lpHisto":[[1386003600000,3]],"dbHisto":[[1386003600000,5287]],"xmax":1387742400000,"xmin":1386003600000,"paHisto":[[1386003600000,46]],"interval":3600},"paHisto":46}]'), "multi items field: rawua");
